# 離床事件預測系統

此系統使用CNN-LSTM深度學習模型預測離床事件，可根據床載數據提前預警。

## 系統架構

系統已按照軟體工程原則進行模組化設計，分為以下幾個主要模組：

1. **配置模組 (config.py)**
   - 包含所有全域常數設定
   - 數據路徑、模型參數等配置

2. **工具模組 (utils.py)**
   - 包含字型設定和通用功能函數
   - 處理檔案路徑、保存處理後序列等

3. **數據處理模組 (data_processing.py)**
   - 負責原始數據的載入、清理和預處理
   - 生成序列資料用於訓練和預測

4. **自訂損失函數模組 (custom_losses.py)**
   - 實作多種基於時間的客製化損失函數
   - 提高模型對離床事件的時間預測精確度

5. **模型定義模組 (model.py)**
   - CNN-LSTM模型架構
   - 自訂評估回調函數

6. **評估模組 (evaluation.py)**
   - 提供多種評估指標和視覺化方法
   - 生成評估報告和圖表

7. **主模組 (main.py)**
   - 整合所有功能，提供命令列介面
   - 處理程式執行流程

8. **初始化模組 (__init__.py)**
   - 模組初始化和導入配置

## 批量FTP下載功能 (Batch FTP Download)

系統提供批量FTP下載功能，可自動下載多個設備的歷史數據並生成截圖報告。

### 功能說明
- **輸入來源**：讀取 `./serial_ids_20250519.csv` 檔案中的設備序號列表
- **時間範圍**：自動下載前2、3、4天的數據（每天從4:00到隔天4:00，共24小時）
- **數據來源**：自動設定為 `FTP:\\RAW` 進行下載
- **自動化處理**：對每個設備的每一天數據進行下載、處理和截圖
- **數據轉換**：下載完成後自動調用批量處理功能，產生對應的數據檔案

### 輸出檔案和資料夾結構

#### 1. 截圖檔案
**位置**：`./_logs/pyqt-viewer/batch_screenshots/`
- **檔案格式**：`{設備序號}_{開始時間}_{結束時間}_screenshot.png`
- **內容**：包含原始數據圖表和位元圖表的完整截圖

#### 2. 原始下載檔案
**位置**：`./_logs/pyqt-viewer/`
- **CMB檔案**：`{設備序號}_{日期}_{時間}.cmb` - 合併的二進制數據檔案
- **TXT檔案**：`{設備序號}_{日期}_{時間}.txt` - 對應的文字記錄檔案

#### 3. 自動產生的數據檔案
**位置**：`./_data/pyqt_viewer/`

執行 `batch_ftp_download` 後會自動產生以下檔案：

**a. 主要數據檔案**：
- **`*_data.csv`** - 過濾後的數據（12:00-隔天12:00）
  - 包含：DateTime, Timestamp, Channel_1-6_Raw/Noise/Max, Rising_Dist_Normal/Air, OnBed_Status
- **`*_full_data.csv`** - 完整的原始數據
  - 包含：所有時間範圍的完整數據記錄
- **`*_parameters.csv`** - 參數設定檔案
  - 包含：各通道的 min_preload, threshold_1, threshold_2, offset level
  - 以及：Total, Noise_1, Noise_2, Set Flip, Air_Mattress, Device_SN, Start_Time

## 批量處理現有檔案功能 (Process Existing CMB Files)

系統新增了獨立的批量處理功能，可以重新處理已下載的 CMB 檔案。

### 功能說明
- **按鈕名稱**：`Process Existing CMB Files`
- **功能**：掃描 `./_logs/pyqt-viewer/` 目錄下的所有 `.cmb` 檔案
- **智能跳過**：自動檢查對應的數據檔案是否已存在，避免重複處理
- **批量轉換**：將 CMB 檔案轉換為與手動操作相同的數據檔案格式

### 使用場景
1. **補充處理**：當 `batch_ftp_download` 執行中斷時，可單獨執行數據轉換
2. **重新處理**：當需要重新產生數據檔案時（例如參數調整後）
3. **歷史數據處理**：處理之前下載但未轉換的歷史 CMB 檔案

### 處理邏輯
1. 掃描 `./_logs/pyqt-viewer/` 目錄下所有 `.cmb` 檔案
2. 檢查對應的 `*_data.csv`, `*_full_data.csv`, `*_parameters.csv` 是否存在
3. 跳過已處理的檔案，只處理缺少數據檔案的 CMB 檔案
4. 自動解析檔案名稱獲取設備序號和時間資訊
5. 調用與手動操作相同的數據處理邏輯
6. 產生與 `FTP:\\RAW` 下載相同格式的數據檔案

### 輸出結果
處理完成後會在 `./_data/pyqt_viewer/` 目錄下產生：
- `{設備序號}_{日期}_{時間}_data.csv`
- `{設備序號}_{日期}_{時間}_full_data.csv`
- `{設備序號}_{日期}_{時間}_parameters.csv`

### 狀態顯示
- 顯示找到的 CMB 檔案數量
- 即時顯示處理進度
- 統計處理成功和跳過的檔案數量
- 顯示處理完成的總結資訊

## 模組化重構

系統重構過程如下：

1. **模組分離**：將原始的單一檔案拆分為多個功能明確的模組，確保每個模組只負責特定功能
2. **依賴關係整理**：修正模組間的導入路徑，確保所有模組能正確引用其他模組
3. **命名標準化**：使用一致的命名規範，提高程式碼可讀性
4. **錯誤處理增強**：增加適當的錯誤處理和日誌記錄
5. **中文支援優化**：確保所有視覺化輸出正確顯示中文字符

重構後的系統具有以下優點：
- 提高程式碼的可讀性和可維護性
- 分離不同功能的關注點
- 更易於進行單元測試和功能擴展
- 簡化團隊協作和代碼審查流程

## 使用方法

### 安裝依賴
```bash
pip install tensorflow pandas numpy matplotlib scikit-learn
```

### 訓練新模型
```bash
python -m model.main
```

### 只進行預測（不訓練）
```bash
python -m model.main --load-only
```

### 設定閾值
```bash
python -m model.main --threshold 0.5
```

### 使用自訂數據路徑
```bash
python -m model.main --input-data /path/to/your/data.csv
```

### 預測新資料（使用現有模型）
```bash
python -m model.main --predict-new --input-data /path/to/your/new_data.csv
```

## 模型結果分析

系統會生成多種圖表和報告來評估模型表現，包括：

1. 事件時間軸圖：顯示真實事件和預測事件的時間分布
2. 時間差異分布圖：分析預測提前時間與目標時間的差異
3. 預測準確率趨勢圖：顯示準確率隨時間的變化
4. 綜合評估報告：包含各項重要指標（檢測率、誤報率、提前時間等）

所有輸出結果預設保存在 `_logs/bed_monitor_test_sum` 目錄下 