# 離群設備截圖PDF生成功能

## 功能描述

這個功能擴展了現有的「批量處理資料夾」流程，在生成共同離群設備分析報告後，自動將這些離群設備的截圖整合成PDF文件，方便快速檢視問題設備。

## 最新更新 (v2.0)

### ✅ 修正問題
1. **中文字體支援**：自動偵測並註冊系統中可用的中文字體，解決亂碼問題
2. **頁面佈局優化**：設備標題與第一張截圖合併在同一頁，提高版面使用效率
3. **跨平台字體支援**：支援 macOS、Windows、Linux 三大平台的中文字體

### 📄 新版PDF佈局
- **第1頁**：封面頁 + 摘要資訊 + 統計表格
- **第2頁**：設備1標題 + 第一張截圖（合併在同一頁）
- **第3頁**：設備1的第二張截圖（如果有）
- **第N頁**：後續設備和截圖

## 功能特點

### 1. 自動化流程
- 與現有批量處理流程完全整合
- 無需額外手動操作
- 自動識別三個關鍵指標(avg_time_diff, match_rate, precision)都為離群值的設備

### 2. 智慧截圖收集
- 自動搜索 `_logs/pyqt-viewer/batch_screenshots/` 目錄下的截圖文件
- 根據設備序號(device_sn)匹配對應的截圖
- 支持一個設備多個時間段的截圖

### 3. 專業PDF報告
- 使用橫向A4格式，適合查看較寬的截圖
- **完整中文字體支援**，無亂碼問題
- 包含摘要資訊和設備統計表格
- 每個設備的截圖按時間順序排列
- 清楚標註設備序號和關鍵指標數值
- **優化版面**：設備標題與第一張截圖在同一頁

## 使用方法

### 前置條件
1. 確保已安裝reportlab模組：
```bash
pip install reportlab
# 或使用poetry
poetry add reportlab
```

2. 確保有有效的截圖文件存在於 `_logs/pyqt-viewer/batch_screenshots/` 目錄中

### 執行步驟
1. 在主程式中點擊「開啟CSV檔案」按鈕
2. 選擇「批量處理資料夾」選項
3. 選擇包含 `*_data.csv` 檔案的資料夾
4. 程式將自動執行以下步驟：
   - 批量分析所有CSV檔案
   - 識別離群設備
   - 收集對應截圖
   - 生成PDF報告

### 輸出文件
PDF文件將保存在 `_logs/pyqt-viewer/batch_prediction_results/` 目錄中，文件名格式為：
```
outlier_devices_screenshots_YYYYMMDD_HHMMSS.pdf
```

## 文件結構

### PDF內容包含：
1. **封面頁**
   - 報告標題
   - 生成時間
   - 離群設備數量統計
   - 分析指標說明

2. **統計表格**
   - 設備序號
   - 三個關鍵指標數值
   - 每個設備的截圖數量

3. **設備詳細頁面**
   - 每個設備單獨分頁
   - 設備基本資訊和指標數值
   - 按時間順序排列的截圖
   - 時間範圍標註

## 截圖文件命名規則

程式會搜索以下格式的截圖文件：
```
{device_sn}_{start_date}_{start_time}_{end_date}_{end_time}_main_window_{timestamp}.png
```

例如：
```
SPS2022PA000072_20250601_040000_20250602_040000_main_window_20250603_120141.png
```

## 故障排除

### 1. PDF生成失敗
- 檢查是否已安裝reportlab模組
- 確認目標目錄有寫入權限

### 2. 找不到截圖文件
- 確認截圖文件存在於正確目錄
- 檢查文件命名是否符合規則
- 確認設備序號與分析結果中的device_sn一致

### 3. PDF為空或內容不完整
- 檢查離群設備分析是否找到符合條件的設備
- 確認對應的截圖文件存在且可讀取

## 技術實作

### 核心模組
- `outlier_pdf_generator.py`：獨立的PDF生成工具
- `save_batch_results()`：整合PDF生成到批量處理流程

### 依賴套件
- `reportlab`：PDF生成
- `os`, `glob`：文件系統操作
- `datetime`：時間處理

### 關鍵函數
- `collect_outlier_screenshots()`：截圖收集
- `generate_outlier_screenshots_pdf()`：PDF生成

## 升級和維護

### 未來可能的改進
1. 支持Google Slides格式輸出
2. 添加更多截圖過濾選項
3. 支持自定義PDF樣式
4. 添加截圖預覽功能

### 版本相容性
- 與現有批量處理流程完全相容
- 不影響原有功能的運行
- 可選擇性啟用PDF生成功能

---

**注意：** 此功能需要在批量處理流程中自動運行，無需額外的用戶介面操作。生成的PDF文件可以直接用標準PDF檢視器開啟。 